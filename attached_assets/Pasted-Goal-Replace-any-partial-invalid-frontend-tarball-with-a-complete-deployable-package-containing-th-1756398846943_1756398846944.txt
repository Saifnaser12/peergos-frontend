Goal: Replace any partial/invalid frontend tarball with a complete, deployable package containing the full Vite build dist/ (including index.html, assets, chunks). Copy the correct tarball to /home/runner/workspace/releases/ and print verification details.
Rebuild from the source project
set -e
ROOT="/home/runner/workspace"
cd "$ROOT/peergos-frontend-prod"
npm ci
npm run typecheck
npm run build
Sanity checks before packaging
test -d dist || (echo "ERROR: dist/ missing" && exit 1)
test -f dist/index.html || (echo "ERROR: dist/index.html missing" && exit 1)
find dist -type f | wc -l | xargs echo "DIST_FILECOUNT"
# Expect a healthy count (>> 10), with JS/CSS assets and index.html present
Ensure API base is env-driven (no hardcoded localhost)
if grep -R --include="*.{ts,tsx,js,jsx}" -nE "http://localhost|127\\.0\\.0\\.1" src || true; then
  echo "ERROR: Found hardcoded localhost references in src/. Please replace with import.meta.env.VITE_API_BASE_URL and rebuild." && exit 1
fi
Create a proper tarball (include ALL of dist + minimal docs)
TS=$(date +%Y%m%d-%H%M)
PKG="peergos-frontend-$TS.tar.gz"
tar -czf "$PKG" \
  --exclude="node_modules" --exclude=".git" --exclude="*.map" --exclude="*.log" \
  dist index.html package.json package-lock.json vite.config.ts tsconfig*.json \
  .env.example MANIFEST_FRONTEND.json FRONTEND_PARITY_REPORT.md README.md
echo "CREATED:$PKG"
tar -tzf "$PKG" | wc -l | xargs echo "PACKAGE_FILECOUNT"
Publish to /releases and show paths
mkdir -p "$ROOT/releases"
cp "$PKG" "$ROOT/releases/"
ls -lh "$ROOT/releases" | sed -n '1,200p'
echo "FRONTEND_PACKAGE_PATH=$ROOT/releases/$PKG"
(Optional) Mark any old/bad frontend package to avoid confusion
# Rename any older peergos-frontend-*.tar.gz that is obviously too small (<100 KB) as .bad
find "$ROOT/releases" -maxdepth 1 -type f -name "peergos-frontend-*.tar.gz" -printf "%p %k KB\n" | awk '$2 < 100 {print $1}' | while read f; do mv "$f" "$f.bad"; echo "RENAMED_BAD:$f -> $f.bad"; done
Final verification output (print exact lines)
echo "VERIFY_FRONTEND: index.html present, DIST_FILECOUNT shown above"
echo "PACKAGE_READY: $ROOT/releases/$PKG"